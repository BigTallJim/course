# Walkthrough - Interacting with PostgreSQL from Ruby

[Back to Challenge](../06_interacting_with_postgres_from_ruby.md)

This walkthrough details how to get a Ruby program interacting with PostgreSQL. It's in three parts:

1. Installing `pg`, a Ruby gem that allows connection to and querying of PostgreSQL
2. Replacing the `Link.all` method, which returns hard-coded links, with a method that fetches link data from a database.
3. Testing that this all worked.

## 1. Installing `pg`

`pg` allows us to:

1. Connect to a PostgreSQL database
2. Execute SQL on that database, directly from Ruby

It's a gem, so we add it to our Gemfile:

```ruby
# Inside Gemfile
# Below other gems
gem 'pg'
```

And install it to the project with `bundle install`.

## 2. Making links fetch data from the database

Now we can connect to and query our database from Ruby, we can update our `Link` class to fetch the links directly from the database.

> Since our Link unit test expects the same three links we're currently storing in our database, we should be able to pass the test seamlessly here.

```ruby
# Inside lib/link.rb
require 'pg'

class Link
  def self.all
    connection = PG.connect(dbname: 'bookmark_manager')
    result = connection.exec("SELECT * FROM links")
    result.map { |link| link['url'] }
  end
end
```

Let's take this line-by-line.

```
connection = PG.connect(dbname: 'bookmark_manager')
```

We ask the `PG` class (provided by the `pg` gem) to connect to the database called 'bookmark manager'. It returns a connection (which we store in a variable called `connection`). We can ask `connection` to do things, like query the database.

```
result = connection.exec("SELECT * FROM links")
```

We ask the `connection` to execute some SQL: `SELECT * FROM links`. This SQL will fetch all links, and the resulting 'result object' is stored in a variable called `result`.

```
result.map { |link| link['url'] }
```

The `result` object contains the links, each of which is a hash of the link ID and link URL. We map each hash to the `url` key of the hash. This gives us an array of the link URLs.

## 3. Testing

We should be able to run our tests and see them passing â€“ even though our new `.all` method fetches data from the database. Similarly, we should be able to run our application and add links, live, to our application via `psql`.

[To the Next Challenge](../07_research_crud.md)
