# Walkthrough - Interacting with PostgreSQL from Ruby

[Back to Challenge](../06_interacting_with_postgres_from_ruby.md)

This walkthrough details how to get a Ruby program interacting with PostgreSQL. It's in three parts:

1. Installing `pg`, a Ruby gem that allows connection to and querying of PostgreSQL
2. Replacing the `Bookmark.all` method, which returns hard-coded bookmarks, with a method that fetches bookmark data from a database.
3. Testing that this all worked.

If you prefer to follow this walkthrough by looking at a 'diff' – a visual difference between deleted and added code – check out [this commit](https://github.com/sjmog/bookmark_manager/commit/b1510f7c355cfba01be71f5e12cf06b87619b547).

## 1. Installing `pg`

`pg` allows us to:

1. Connect to a PostgreSQL database
2. Execute SQL on that database, directly from Ruby

It's a gem, so we add it to our Gemfile:

```ruby
# Inside Gemfile

source "https://rubygems.org"
gem 'sinatra'
gem 'rspec'
gem 'capybara'
gem 'pg'
```

And install it to the project with `bundle install`.

## 2. Making `Bookmark` fetch data from the database

Now we can connect to and query our database from Ruby, we can update our `Bookmark` model to fetch the bookmarks directly from the database.

> Since our Bookmark unit test expects the same three bookmarks we're currently storing in our database, we should be able to pass the test seamlessly here.

```ruby
# Inside lib/bookmark.rb
require 'pg'

class Bookmark
  def self.all
    connection = PG.connect(dbname: 'bookmark_manager')
    result = connection.exec("SELECT * FROM bookmarks")
    result.map { |bookmark| bookmark['url'] }
  end
end
```

Let's take this line-by-line.

```
connection = PG.connect(dbname: 'bookmark_manager')
```

We ask the `PG` class (provided by the `pg` gem) to connect to the database called 'bookmark manager'. It returns a connection (which we store in a variable called `connection`). We can ask `connection` to do things, like query the database.

```
result = connection.exec("SELECT * FROM bookmarks")
```

We ask the `connection` to execute some SQL: `SELECT * FROM bookmarks`. This SQL will fetch all bookmarks, and the resulting 'result object' is stored in a variable called `result`.

```
result.map { |bookmark| bookmark['url'] }
```

The `result` object contains the bookmarks, each of which is a hash of the bookmark ID and bookmark URL. We map each hash to the `url` key of the hash. This gives us an array of the bookmark URLs.

## 3. Testing

We should be able to run our tests and see them passing – even though our new `.all` method fetches data from the database. Similarly, we should be able to run our application and add bookmarks, live, to our application via `psql`.

> If your test isn't passing – take a look in your database. Is the data in the database an exact match for the data your app expects?

[To the Next Challenge](../07_upgrading_your_toolset.md)
