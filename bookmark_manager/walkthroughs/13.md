# Walkthrough - The ORM pattern

[Back to Challenge](../13_the_orm_pattern.md)

This walkthrough is in 4 parts:

1. Update the `Link.all` method to return an array of links, not an array of URLs.
2. Update the `Link` instances to have attributes for `id` and `url`.
3. Add a `title` attribute to Links.
4. Update the rest of our application to use this `title` attribute.

## 1. Updating the `Link.all` method to encapsulate URLs in a Link instance

I find it helpful to think about features from the view backwards. In our `index.erb` view, we'd like something like this:

```html
<ul>
  <% @links.each do |link| %>
    <a href="<%= link.url %>">
      <%= link.title %>
    </a>
  <% end %>
</ul>
```

> An `<a>` tag is used to link to other webpages. It's a tag that creates browser links.

At the moment, we can't do this: `@links` comes from the controller, which calls `Link.all`, which returns an array of strings (each string is a URL). Therefore, we can't call `link.url` on a string, and neither can we call `link.title` (which we want to do later).

We want something like the following:

```ruby
Link.all
# => [<#Link:0x8928234 @id="1" @url="http://www.makersacademy.com">, ...]
```

That is: we want `Link.all` to give us an array of links, not an array of link URLs.

> A commit for this step is [here](https://github.com/sjmog/bookmark_manager/commit/0caa293027f8057c12f9e14fa0215567e4fa199c).

Our first step is to update the `link_spec.rb` test for `Link.all`:

```ruby
# in spec/link_spec.rb

describe '.all' do
  it 'returns all links, wrapped in link instances' do
    links = Link.all

    # Insert this line to map all the links to urls
    urls = links.map(&:url)

    expect(urls).to include("http://www.makersacademy.com")
    expect(urls).to include("http://www.google.com")
    expect(urls).to include("http://www.facebook.com")
  end
end
```

Now that we have a failing test, let's fix it in `link.rb`:

```ruby
# in lib/link.rb

class Link
  attr_reader :url

  def initialize(url)
    @url = url
  end

  def self.all
    result = connection.exec("SELECT * FROM links")

    # We'll wrap each row that comes back in a new instance of the Link class
    result.map { |link| Link.new(link['url']) }
  end

  ### rest of the class ###
end
```

This passes our currently-failing test! But it breaks the tests for `Link.create`. We need to update these tests that rely on `Link.all`:

```
# in spec/link_spec.rb

describe '.create' do
  it 'creates a new link' do
    Link.create(url: 'http://www.testlink.com')

    # map the links to their URLs
    links = Link.all
    urls = links.map(&:url)

    expect(urls).to include 'http://www.testlink.com'
  end

  it 'does not create a new link if the URL is not valid' do
    Link.create(url: 'not a real link')

    # map the links to their URLs
    links = Link.all
    urls = links.map(&:url)

    expect(urls).not_to include 'not a real link'
  end
end
```

Our `link_spec.rb` tests now pass – but our feature tests don't. We need to update the `index.erb` page to use these new, wrapped link urls:

```diff
 <!-- in index.erb -->

 <ul>
   <% @links.each do |link| %>
-    <li><%= link %></li>
+    <li><%= link.url %></li>
   <% end %>
 </ul>
```

## 2. Update the `Link` instances to have attributes for `id` and `url`.

Now that we've wrapped each result of `Link.all` in a `Link` instance, we can easily add `id` and `url` to them. Since there's no logic involved here, we don't even have to write a spec!

> If you prefer working from the commit steps, a commit for this step is [here](https://github.com/sjmog/bookmark_manager/commit/fe9bb96c9598a25f0bb4fff05821cb0b43230cdd).

```diff
 # in lib/link.rb

  class Link
 -  attr_reader :url
 +  attr_reader :id, :url
  
 -  def initialize(url)
 +  def initialize(id, url)
 +    @id = id
      @url = url
    end
  
    def self.all
      result = connection.exec("SELECT * FROM links")
 -    result.map { |link| Link.new(link['url']) }
 +    result.map { |link| Link.new(link['id'], link['url']) }
    end
 
   ### rest of the class ###
 end
```

We can now use these attributes in our view:

```diff
<!-- in views/index.erb -->

 <ul>
   <% @links.each do |link| %>
-    <li><%= link.url %></li>
+    <li id="link-<%= link.id %>"><%= link.url %></li>
   <% end %>
 </ul>
```

## 3. Add a `title` attribute to Links.

To add a `title` attribute to Links, we need to:

- Add a column to the database table.
- Update our Link objects to wrap this new data.

### Add a column to the database table.

We can add columns to the database table by updating our Rake task that sets up databases:

```diff
# in Rakefile

task :test_database_setup do
   connection.exec("TRUNCATE links;")
 
   # Add the test data
-  connection.exec("INSERT INTO links VALUES(1, 'http://www.makersacademy.com');")
-  connection.exec("INSERT INTO links VALUES(2, 'http://www.google.com');")
-  connection.exec("INSERT INTO links VALUES(3, 'http://www.facebook.com');")
+  connection.exec("INSERT INTO links VALUES(1, 'http://www.makersacademy.com', 'Makers Academy');")
+  connection.exec("INSERT INTO links VALUES(2, 'http://www.google.com', 'Google');")
+  connection.exec("INSERT INTO links VALUES(3, 'http://www.facebook.com', 'Facebook');")
 end
 
 task :setup do
     connection = PG.connect
     connection.exec("CREATE DATABASE #{ database };")
     connection = PG.connect(dbname: database)
-    connection.exec("CREATE TABLE links(id SERIAL PRIMARY KEY, url VARCHAR(60));")
+    connection.exec("CREATE TABLE links(id SERIAL PRIMARY KEY, url VARCHAR(60), title VARCHAR(60));")
   end
 end
```

Now we have to delete our databases, and run the `rake setup` task again: and our databases will be in the right shape.

> This is obviously pretty unhelpful. Every time we run `rake setup` like this we lose all our data. In other words: right now, we lose all our data every time we want to change the database. This is a problem solved by _migrations_, which you'll meet shortly. If you're up for a challenge – try to write an extra rake task, called `migrate`, that doesn't destroy the database data when adding new columns.

### Update our Link objects to wrap this new data.

We can update our Link objects just as we did when wrapping the `id` attribute:

```diff
 # in lib/link.rb

 class Link
-  attr_reader :id, :url
+  attr_reader :id, :url, :title
 
-  def initialize(id, url)
+  def initialize(id, url, title)
     @id = id
     @url = url
+    @title = title
   end
 
   def self.all
     result = connection.exec("SELECT * FROM links")
-    result.map { |link| Link.new(link['id'], link['url']) }
+    result.map { |link| Link.new(link['id'], link['url'], link['title']) }
   end

   ### rest of the class ###
 end
```

## 4. Update the rest of our application to use this `title` attribute.

We need to update various parts of the application to use the new `title` attribute. This includes:

- The feature specs, which are currently looking for URLs but should look for titles.
- The homepage, which current displays links but should display link titles, wrapped in an anchor tag pointing to the link URL.
- The 'new link' form, which currently only allows users to create links with URLs but should allow them to add a title as well.
- The `POST /create-a-new-link` route, which currently only looks for a URL parameter, but should look for a title as well.
- The `Link.create` method, which currently only creates Links with `url`s, but should also create links with `title`s as well.

Rather than write out every step here, [here](https://github.com/sjmog/bookmark_manager/commit/a81b97b4abd85809c844e7951b8741f72e760a6f) is a commit with each of those updates completed. Use this commit to understand how each of the problems above is solved.

[Next Challenge](../14_crud.md)
