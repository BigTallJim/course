# Solution

[Back to Challenge](../26_password_recovery.md)

### Password Recovery

A user should be able to request a password reset from the sign-in page which will ask them to enter email address.

```ruby
feature 'Resetting Password' do
 scenario 'When I forget my password I can see a link to reset' do
   visit '/sessions/new'
   click_link 'I forgot my password'
   expect(page).to have_content("Please enter your email address")
   expect(current_path).to eq "/users/recover"
 end
end
```

We create the link for requesting a password recovery.

```ruby
 # app/views/sessions/new.erb
 ...
 
 <a href="/users/recover">I forgot my password</a>
```

In the controller all we need to do is display the expected message to pass the test.

```ruby
  # app/controllers/users.rb
  ...
  
  get '/users/recover' do
    "Please enter your email address"
  end
```

The tests should now pass.

The page needs to allow the user to submit their email address for recovery. For security reasons we always want to display the "Please check your inbox" message, even if the user doesn't exist. This stops people from being able to know if you are signed up to a website by trying to recover your password.

```ruby
scenario 'When I enter my email I am told to check my inbox' do
   visit '/users/recover'
   fill_in :email, with: "alice@example.com"
   click_button "Submit"
   expect(page).to have_content "Thanks, Please check your inbox for the link."
 end
 ```
 
```html
# app/views/users/recover.erb
   
<form action="/users/recover" method="post">
   <label for="email"> Please enter your email address
     <input type="email" name="email" required>
     <input type="submit" value="Submit">
   </label>
</form>
```
 
```ruby
  # app/controllers/users.erb
 
  post '/users/recover' do
    erb :'users/acknowledgement'
  end
```

```html
# app/views/users/acknowledgement

Thanks, Please check your inbox for the link.
```
 
Because we're now repeating ourselves by clicking on the links, we'll now change it to a method to dry up our code.
We also test for a password token being set on the user, when a recovery request is submitted.

```ruby
 scenario 'When I enter my email I am told to check my inbox' do
   recover_password
   expect(page).to have_content "Thanks, Please check your inbox for the link."
 end
 
  scenario 'assigned a reset token to the user when they recover' do
    sign_up
    expect{recover_password}.to change{User.first.password_token}
  end
 
  def recover_password
    visit '/users/recover'
    fill_in :email, with: "alice@example.com"
    click_button "Submit"
  end
```
 
 We need to add `password_token` as a property on the User model.
 ```ruby
   # models/users.rb
   ...
   
   property :password_token, Text
 ```
 
 We now generate a token in the controller, using a `generate_token` method which we need to create.
 
 ```ruby
   # controllers/users.rb
   post '/users/recover' do
     user = User.first(email: params[:email])
     if user
       user.generate_token
     end
     
     erb :'users/acknowledgment'
   end
 ```
 
 We're going to create a unit test for generating a token. All we care about now is that it changes, and we can worry about the implementation later.
 
```ruby
it "saves a password recovery token when we generate a token using" do
   expect{user.generate_token}.to change{user.password_token}
end
```

```ruby
# app/models/user.rb
require 'securerandom'
...

def generate_token
  self.password_token = SecureRandom.hex
end
```

We've used SecureRandom as it securely generates a random string better than we could manually.
 
Now both the tests should pass.


 Setting the token timestamp
 
 Require and bundle Timecop gem for freezing time.
 
 
 
 
 Now is a good time extract out some of the setup into a before block. We know that if a user will reset their password that they have previously signed up, and we clear their session so they are not signed in. This will help us construct our tests.
  
 ```ruby

 # spec/reset_password_spec.rb
 before do 
   sign_up
   Capybara.reset!
 end
 let(:user) { User.first }
```
 
```ruby  
# controller/users.rb

post '/users/recover' do
  user = User.first(email: params[:email])
  if user
    user.generate_token
  end
  erb :'users/acknowledgment'
end
```

```ruby
# models/users.rb
require 'securerandom'
...

property :password_token_time, DateTime
...

def generate_token
  self.password_token = SecureRandom.hex
  self.password_token_time = Time.now
  self.save
end
```
Tests should pass
Password reset page

```ruby
# spec/reset_password_spec.rb
scenario 'it asks for your new password when your token is valid' do
   recover_password
   visit("/users/reset_password?token=#{user.password_token}")
   expect(page).to have_content("Please enter your new password")
 end
```

```ruby
# app/controllers/user.rb
get '/users/reset_password' do
  "Please enter your new password"
end
```
Tests should pass
Token invalidation

```ruby
# spec/reset_password_spec.rb

scenario 'it doesn\'t allow you to use the token after an hour' do
  recover_password
  Timecop.travel(60 * 60 * 60) do
    visit("/users/reset_password?token=#{user.password_token}")
    expect(page).to have_content "Your token is invalid"
  end
end
```
```ruby
# app/controllers/user.rb
get '/users/reset_password' do
  @user = User.find_by_valid_token(params[:token])
  if(@user)
    "Please enter your new password"
  else
    "Your token is invalid"
  end
end
```
```ruby

# spec/models/user_spec.rb

it 'can find a user with a valid token' do
   user.generate_token
   expect(User.find_by_valid_token(user.password_token)).to eq user
 end
```

```ruby
# app/models/user.rb

def self.find_by_valid_token(token)
  first(password_token: token)
end
```

```ruby

# spec/models/user_spec.rb
 it 'can\'t find a user with a token over 1 hour in the future' do
   user.generate_token
   Timecop.travel(60 * 60 + 1) do
    expect(User.find_by_valid_token(user.password_token)).to eq nil
   end
 end
```

```ruby
# app/models/user.rb

def self.find_by_valid_token(token)
  user = first(password_token: token)
  if (user && user.password_token_time + (60 * 60) > Time.now)
    user
  end
end
```
Tests should pass

Entering a new password

```ruby
# spec/reset_password_spec.rb

scenario 'it lets you enter a new password with a valid token' do
  recover_password
  visit("/users/reset_password?token=#{user.password_token}")
  fill_in :password, with: "newpassword"
  fill_in :password_confirmation, with: "newpassword"
  click_button "Submit"
  expect(page).to have_content("Please sign in")
end
```

```ruby
# app/controllers/users_controller.rb

get '/users/reset_password' do
  @user = User.find_by_valid_token(params[:token])
  if(@user)
    erb :'users/reset_password'
  else
    "Your token is invalid"
  end
end
```

```ruby
# views/user/reset_password.rb

<h1>Please enter your new password</h1>

<form action='/users/reset_password' method='post'>
 <label for='password'>
   Password: <input name='password' type='password'>
 </label>
 <label for='password_confirmation'>
   Password Confirmation: <input name='password_confirmation' type='password'>
 </label>
 <input type='submit' value='Submit'>
</form>
```

```ruby
  # app/controllers/users.rb
  post '/users/reset_password' do
    redirect "/sessions/new"
  end
```

Tests should pass

Signing in with the new password

```ruby 
# spec/reset_password_spec.rb

scenario 'it lets you sign in after password reset' do
   recover_password
   visit("/users/reset_password?token=#{user.password_token}")
   fill_in :password, with: "newpassword"
   fill_in :password_confirmation, with: "newpassword"
   click_button "Submit"
   sign_in(email: "alice@example.com", password: "newpassword")
   expect(page).to have_content "Welcome, alice@example.com"
 end
 ```
 
 ```ruby
 # app/controllers/users.rb
 
 post '/users/reset_password' do
   user = User.find_by_valid_token(params[:token])
   user.password = params[:password]
   user.password_confirmation = params[:password_confirmation]
   user.save
   redirect "/sessions/new"
 end
 ```

Checking password confirmation

```ruby
# spec/reset_password_spec.rb

scenario 'it lets you know if you\'re passwords don\'t match' do
   recover_password
   visit("/users/reset_password?token=#{user.password_token}")
   fill_in :password, with: "newpassword"
   fill_in :password_confirmation, with: "wrongpassword"
   click_button "Submit"
   expect(page).to have_content("Password does not match the confirmation")
 end
 ```
 
 ```ruby
 # app/controllers/users.rb
 post '/users/reset_password' do
   user = User.find_by_valid_token(params[:token])
   user.password = params[:password]
   user.password_confirmation = params[:password_confirmation]
   if user.save
     redirect "/sessions/new"
   else
     flash.now[:errors] = user.errors.full_messages
     erb :'users/reset_password'
   end
 end
 ```

[next challenge](../26_password_recovery.md)
