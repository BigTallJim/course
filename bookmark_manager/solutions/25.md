# Solution

[Back to Challenge](../26_password_recovery.md)

Write a test for giving users the ability to ask for password recovery
```ruby
feature 'Resetting Password' do
 scenario 'When I forget my password I can see a link to reset' do
   visit '/sessions/new'
   click_link 'I forgot my password'
   expect(page).to have_content("Please enter your email address")
   expect(current_path).to eq "/users/recover"
 end
end
```

```ruby
 # app/views/sessions/new.erb
 ...
 
 <a href="/users/recover">I forgot my password</a>
```

```ruby
  # app/controllers/users.rb
  ...
  
  get '/users/recover' do
    "Please enter your email address"
  end
```

Allowing user to submit their email address for recovery 

```ruby
scenario 'When I enter my email I am told to check my inbox' do
   visit '/users/recover'
   fill_in :email, with: "alice@example.com"
   click_button "Submit"
   expect(page).to have_content "Thanks, Please check your inbox for the link."
 end
 ```
 
 ```html
   # app/views/users/recover.erb
   
<form action="/users/recover" method="post">
   <label for="email"> Please enter your email address
     <input type="email" name="email" required>
     <input type="submit" value="Submit">
   </label>
</form>
 ```
 
 ```ruby
   # app/controllers/users.erb
  
   post '/users/recover' do
     erb :'users/acknowledgement'
   end
 ```
 
 ```html
   # app/views/users/acknowledgement
   Thanks, Please check your inbox for the link.
  ```
  
  Setting the token 
  _____________refactor ______________

  ```ruby
   scenario 'When I enter my email I am told to check my inbox' do
     recover_password
     expect(page).to have_content "Thanks, Please check your inbox for the link."
   end
   
    scenario 'assigned a reset token to the user when they recover' do
      sign_up
      expect{recover_password}.to change{User.first.password_token}
    end
   
    def recover_password
      visit '/users/recover'
      fill_in :email, with: "alice@example.com"
      click_button "Submit"
    end
  ```
  
  ```ruby
    # models/users.rb
    ...
    
    property :password_token, Text
  ```
  ```ruby
    # controllers/users.rb

    post '/users/recover' do
      user = User.first(email: params[:email])
      if user
        user.generate_token
      end
      
      erb :'users/acknowledgment'
    end
  ```
  
  Setting the token timestamp
  
  Require and bundle Timecop gem for freezing time.
  
  ```ruby
  # spec/reset_password_spec.rb
  before { sign_up }
  let(:user) { User.first }
  scenario 'it sets the time the password was saved' do
    Timecop.freeze do
      recover_password
      expect(user.password_token_time).to eq(Time.now)
    end
  end
 ```
 
```ruby  
# controller/users.rb

post '/users/recover' do
  user = User.first(email: params[:email])
  if user
    user.generate_token
  end
  erb :'users/acknowledgment'
end
```

```ruby
# models/users.rb
require 'securerandom'
...

property :password_token_time, DateTime
...

def generate_token
  self.password_token = SecureRandom.hex
  self.password_token_time = Time.now
  self.save
end
```

Password reset page

```ruby
# spec/reset_password_spec.rb
scenario 'it asks for your new password when your token is valid' do
   recover_password
   visit("/users/reset_password?token=#{user.password_token}")
   expect(page).to have_content("Please enter your new password")
 end
```

```ruby
# app/controllers/user.rb
get '/users/reset_password' do
  "Please enter your new password"
end
```

Token invalidation

```ruby
# spec/reset_password_spec.rb

scenario 'it doesn\'t allow you to use the token after an hour' do
  recover_password
  Timecop.travel(60 * 60 * 60) do
    visit("/users/reset_password?token=#{user.password_token}")
    expect(page).to have_content "Your token is invalid"
  end
end
```
```ruby
# app/controllers/user.rb
get '/users/reset_password' do
  @user = User.find_by_valid_token(params[:token])
  if(@user)
    "Please enter your new password"
  else
    "Your token is invalid"
  end
end
```
 
```ruby
# app/models/user.rb

def self.find_by_valid_token(token)
  user = first(password_token: token)
  if (user && user.password_token_time + (60 * 60) > Time.now)
    user
  end
end
```
[next challenge](../26_password_recovery.md)
